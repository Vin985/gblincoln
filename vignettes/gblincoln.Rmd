---
title: "Introduction to the gblincoln package"
output: rmarkdown::html_vignette
description: >
  This is an introduction to the gblincoln package to calculate Lincoln
  population abundance estimates using banding data recovered from the Gamebirds
  database. 
vignette: >
  %\VignetteIndexEntry{gblincoln}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(gblincoln)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Goal of this vignette

This vignette aims to give an overview of how to use the `gblincoln` package
by:

  * [Explaining concepts](#basic-concepts-regarding-lincoln-estimations) 
  surrounding Lincoln estimation
  * [Describing how to perform each task](#package-description) with the package
  * [Providing a detailed example](#example) for calculating Lincoln estimates for a
population of Atlantic brants (ATBR) using harvest data gathered in
the United States.
  * [Providing additional information](#additional-information) about the package


Note that all relevant code portions of this example can
be found in the `ATBR_example.R` file found at the root of the gblincoln package.

## Package requirements

This package depends on the `tidyverse` and `ggplot2` libraries.

## Basic concepts regarding Lincoln estimations

Lincoln estimates are calculated by using the number of banded birds and the
number of recovered bands from hunting for a given year and species.
Coupled with a probability of reporting the band data for that year, this allows
us to estimate a harvest rate for that year. This rate is then applied to 
harvest numbers for that year and species to give an estimate of population
abundance. The principles and equations used in this package are described in
Alisauskas *et al.*, (2014)

### Data requirements

Data from four (4) sources are required to perform the estimations:

 * Banding data
 * Recovery data of banded birds
 * Probability of reporting banding information from recovered birds
 * Harvest data


### Actions performed

The main workflow for calculating Lincoln estimates for a given species is 
as follows:

 * Load and clean datasets to make sure they are consistent with one another
 * Filter the banding and recoveries datasets for the population of interest
 * Calculate the number of direct recoveries for each year
 * Estimate the harvest rate
 * Calculate the Lincoln estimates for that population
 
 
## Package description

The `gblincoln` package aims to calculate Lincoln estimates for population abundance 
using banding data extracted from the Gamebirds database provided by the
**US Banding service**.
The gblincoln package offers functions to perform all steps required to calculate
Lincoln estimates as described in the previous section. In addition, the 
package offers convenience functions for:

 * Comparing multiple filters (e.g. bands with geolocators or not)
 * Listing all availables areas for a given species of birds
 * Plotting comparisons
 * Plotting abundance estimates
 
Since deciding which harvest data to use can be very dependent of the
populations and species studied, this package only performs estimations for
one species at a time. To perform multiple estimations, multiple filters
should be defined and executed one at a time.

### Loading data

All datasets should be loaded using  the **`load_dataset()`** function.
This function performs the following:

 * Load a csv file
 * Rename the columns to ensure consistency between datasets. For more
  information about column renaming, please refer to [this section](#column-names)
 * Classify the age of the birds in two classes: Hatch year (HY) and after hatch
  year (AHY) (Only for banding and recovery data)
 * Correct the recovery year to account for hunting season (recovery data only).
 [Click here](#recovery-year-correction) for more details.
 * Ensure sex classes are properly defined (only banding and recovery data)

If the data to be loaded is not in a csv format, it is possible to load the data
using the appropriate method and then call the **`clean_dataset()`** function on the
resulting dataframe.
The type of action taken during cleaning is determined automatically by the columns present
in the dataset. Please see the help page of the `clean_dataset()` function for
further explanations.

To load a csv file from an external path, we would write something like this:

```{r eval=FALSE}
dataset <- load_dataset("path_to_file")
```

### Filtering the databases

By default, the data extracted from gamebirds is unfiltered and can contain
unwanted entries. Therefore, we need to define filters to select only the
relevant data.
In `gblincoln`, filtering is done by creating a list of filters that associate
the name of a column from the dataset with the desired value.

For example, let's say we want to keep only birds banded between 2010 and 2020.
Banding year in the datasets is stored in the column `b.year`. Therefore to create
this filter, we would write:

```{r}
filter <- list(b.year=2010:2020) 
```
 

You might notice that `b.year` is not a column found in the original datasets
extracted from Gamebirds and was renamed by the package. If you prefer
to use the original names given by Gamebirds, it is also possible as long as the
column is present in the list of columns accepted by the package. See the
[section on column names](#column-names) for more information.
For instance, the original column name is actually `B.Year` so you
could define your filter like this and achieve the same results:

```{r}
filter_old_name <- list(B.Year=2010:2020)
```


If you want to reuse an old filter and only change one of its values or add
another filtering value, you can do so by updating the list using the
`list_update()` function

```{r}
updated_list <- list_update(filter, list(b.year=2009:2019, spec="ATBR"))
```

Note that only the columns present in the dataframe will actually be filtered.
This allows you to create only one filter that can be applied for banding and recovery
data. Filtering will be done in the order in which the filter appear in the
list. 


For our example, we will look into data of the ATBR species, banded in
Nunavut, recovered in the United States in the flyway 1. (Note: if you need
more information about location and flyways available for a given species
please see [this section](#species-locations))

```{r}
filters_ATBR <-
  list(
    SPEC = "ATBR",
    b.state_name = "Nunavut",
    e.country_code = 'US',
    r.flyway_code = 1
  )
```

To use the filter, you can then call the `filter_database()` function.

```{r}
ATBR_banding <- filter_database(gb_ATBR_banding, filters_ATBR)
```

Note that by default, the `filter_database()` function automatically adds some
filters. This include keeping only relevant columns, type of bands,
type of birds, how the birds are recovered etc.
The complete list of default values can be found in the following object:

```{r}
DEFAULT_LINCOLN_FILTERS
```

If you want to change the value of a specific filter, just add it
in your filter list, it will automatically override the default value.
If you do not want to use the default values, you can set 
`use_default_filters=FALSE` when calling the `filter_database()`function.



## Example

Estimating the population of Atlantic Brant in North America

### Load data

For this example, we will be using datasets provided with the package. For more 
detailed information about these datasets please see 
[this section](#provided-datasets). All the data provided with the package
come from raw data loaded using the `load_dataset()` function.

The four (4) required datasets are provided in the packaeg. Here are the name of
the variables containing them:

 * Banding data. `gb_ATBR_banding`
 * Recovery data: `gb_ATBR_recovery`
 * Reporting_probabilities: `gb_reporting_probas`
 * Harvest data: `gb_ATBR_harvest`
 
Therefore to load the example data, all that is required is to load the package.

```{r setup}
# Clean environment and load the package
rm(list=ls())
library(gblincoln)

# Banding data
str(gb_ATBR_banding)
# Reporting probabilities
head(gb_reporting_probas)
# Harvest data
head(gb_ATBR_harvest)
```

### Filter datasets


For our example, we will look into data of the ATBR species, banded in
Nunavut, recovered in the United States in the flyway 1. (Note: if you need
more information about location and flyways available for a given species
please see [this section](#species-locations))

```{r}
filters_ATBR <-
  list(
    SPEC = "ATBR",
    b.state_name = "Nunavut",
    e.country_code = 'US',
    r.flyway_code = 1
  )
```

To use the filter, you can then call the `filter_database()` function.

```{r}
ATBR_banding <- filter_database(gb_ATBR_banding, filters_ATBR)
```


### Get direct recoveries
### Calculate harvest rate from banding data (not used for estimates but for
comparison between band types)
### Estimate abundance based on harvest data

### See results


# Compare two filters
## Defining the filters
## Calculate harvest rate
## Compare and plot


## Additional information

### Extracting data from gamebirds

### Column names
GB_COLNAMES
#### Add your own column names

### Recovery year correction

### Provided datasets

This vignette uses datasets shipped with the gblincoln package. The provided
datasets are:

  * `gb_ATBR_banding`: Banding data for the ATBR species extracted from the
  Gamebirds database. This  dataset has already been cleaned using
  the `clean_dataset()` function.
  
TODO: Provide raw data to explain all steps
  

### Species locations

### Gamebirds banding

### Gamebirds recoveries

### Reporting probability
Say that a version is available in the package

### Harvest data
Depends on the species
